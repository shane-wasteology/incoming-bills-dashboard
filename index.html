<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Incoming Bills Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', -apple-system, sans-serif; background: linear-gradient(180deg, #1e2a38 0%, #151f2b 100%); color: #e2e8f0; min-height: 100vh; }
    .container { padding: 24px; max-width: 1400px; margin: 0 auto; }
    .header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; border-bottom: 1px solid #3d4f63; padding-bottom: 16px; }
    .logo { width: 44px; height: 44px; border-radius: 8px; background: #4A9B52; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 18px; }
    .title { font-size: 18px; font-weight: 600; color: #4A9B52; letter-spacing: 2px; text-transform: uppercase; }
    .subtitle { font-size: 12px; color: #64748b; margin-top: 2px; }
    .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .kpi-card { background: #2a3a4d; border: 1px solid #3d4f63; border-radius: 8px; padding: 16px; }
    .kpi-label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .kpi-value { font-size: 28px; font-weight: 700; color: #4A9B52; }
    .kpi-value.alert { color: #f59e0b; }
    .kpi-sub { font-size: 11px; color: #64748b; margin-top: 4px; }
    .tab-row { display: flex; gap: 4px; margin-bottom: 20px; }
    .tab { padding: 8px 16px; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; background: transparent; color: #64748b; border: 1px solid #3d4f63; }
    .tab.active { background: #4A9B52; color: #fff; border-color: #4A9B52; }
    .panel { background: #2a3a4d; border: 1px solid #3d4f63; border-radius: 8px; padding: 20px; display: none; }
    .panel.active { display: block; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .panel-title { font-size: 13px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
    .panel-title::before { content: ''; width: 12px; height: 12px; background: #4A9B52; border-radius: 2px; }
    .chart-container { height: 320px; margin-bottom: 16px; position: relative; }
    .info-box { margin-top: 16px; padding: 10px 14px; background: rgba(74, 155, 82, 0.1); border: 1px solid rgba(74, 155, 82, 0.2); border-radius: 6px; font-size: 11px; color: #4A9B52; }
    .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px; }
    .stat-box { background: #1e2a38; border: 1px solid #3d4f63; border-radius: 6px; padding: 12px; }
    .stat-label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 18px; font-weight: 700; color: #4A9B52; margin-top: 4px; }
    .select { background: #1e2a38; border: 1px solid #3d4f63; border-radius: 4px; padding: 6px 12px; font-size: 12px; color: #e2e8f0; cursor: pointer; min-width: 180px; }
    .legend { font-size: 11px; color: #94a3b8; display: flex; align-items: center; gap: 6px; }
    .legend-line { width: 20px; height: 2px; background: #f59e0b; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th { text-align: left; padding: 10px 12px; color: #64748b; font-weight: 500; text-transform: uppercase; font-size: 10px; border-bottom: 1px solid #3d4f63; }
    th.right { text-align: right; }
    td { padding: 10px 12px; border-bottom: 1px solid #1e2a38; color: #e2e8f0; }
    td.right { text-align: right; }
    td.muted { color: #94a3b8; }
    td.red { color: #ef4444; font-weight: 600; }
    td.green { color: #22c55e; font-weight: 600; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    .badge.spike { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
    .alert-box { margin-top: 20px; padding: 12px 16px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 6px; font-size: 11px; color: #f59e0b; }
    svg text { font-family: 'Segoe UI', -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">W</div>
      <div>
        <div class="title">Incoming Bills</div>
        <div class="subtitle">Invoice volume monitoring • Data through 12/17/2025</div>
      </div>
    </div>

    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Yesterday</div>
        <div class="kpi-value" id="kpi-yesterday">398</div>
        <div class="kpi-sub">12/17</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">December MTD</div>
        <div class="kpi-value" id="kpi-mtd">4,917</div>
        <div class="kpi-sub">17 days</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Year to Date</div>
        <div class="kpi-value" id="kpi-ytd">159,850</div>
        <div class="kpi-sub">Jan - Nov 2025</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Alerts (Nov Close)</div>
        <div class="kpi-value alert" id="kpi-alerts">8</div>
        <div class="kpi-sub">vendors below 25%</div>
      </div>
    </div>

    <div class="tab-row">
      <button class="tab active" data-tab="daily">Daily MTD</button>
      <button class="tab" data-tab="monthly">Monthly Trend</button>
      <button class="tab" data-tab="alerts">Alerts (8)</button>
    </div>

    <div class="panel active" id="panel-daily">
      <div class="panel-header">
        <div class="panel-title">December 2025 — Daily Invoice Count</div>
        <div class="legend"><span class="legend-line"></span> Avg 289/day</div>
      </div>
      <div class="chart-container" id="daily-chart"></div>
      <div class="info-box">Weekend days shown at reduced opacity. Orange dashed line = daily average (289 invoices).</div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">MTD Total</div><div class="stat-value">4,917</div></div>
        <div class="stat-box"><div class="stat-label">Daily Avg</div><div class="stat-value">289</div></div>
        <div class="stat-box"><div class="stat-label">Peak Day</div><div class="stat-value">12/16</div></div>
        <div class="stat-box"><div class="stat-label">Peak Volume</div><div class="stat-value">425</div></div>
      </div>
    </div>

    <div class="panel" id="panel-monthly">
      <div class="panel-header">
        <div class="panel-title">Monthly Invoice Volume</div>
        <select class="select" id="vendor-select">
          <option value="All Vendors">All Vendors</option>
          <option value="Waste Management">Waste Management</option>
          <option value="Republic Services">Republic Services</option>
          <option value="GFL Environmental">GFL Environmental</option>
          <option value="Rumpke">Rumpke</option>
        </select>
      </div>
      <div class="chart-container" id="monthly-chart"></div>
      <div class="info-box">Showing completed months only (Jan - Nov 2025).</div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">YTD Total</div><div class="stat-value" id="stat-ytd">159,850</div></div>
        <div class="stat-box"><div class="stat-label">Monthly Avg</div><div class="stat-value" id="stat-monthly-avg">14,532</div></div>
        <div class="stat-box"><div class="stat-label">Peak Month</div><div class="stat-value" id="stat-peak-month">Nov</div></div>
        <div class="stat-box"><div class="stat-label">Peak Volume</div><div class="stat-value" id="stat-peak-vol">16,200</div></div>
      </div>
    </div>

    <div class="panel" id="panel-alerts">
      <div class="panel-header">
        <div class="panel-title">Volume Alerts (Oct → Nov)</div>
        <div style="font-size: 11px; color: #64748b;" id="alerts-count-label">0 vendors flagged</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Vendor</th>
            <th class="right">Oct Count</th>
            <th class="right">Nov Count</th>
            <th class="right">% of Prior</th>
            <th class="right">Status</th>
          </tr>
        </thead>
        <tbody id="alerts-table"></tbody>
      </table>
      <div class="alert-box">⚠ Action Required: Investigate vendors with unusual volume changes. Drops may indicate: contract ended, billing address changed, invoices routing to wrong location. Spikes may indicate: duplicate invoices, billing errors.</div>
      <div class="info-box">Alerts trigger for vendors with ≥10 prior invoices showing &lt;25% or &gt;125% of prior month volume.</div>
    </div>
  </div>

  <script>
    // ============================================================
    // CSV LOADING
    // ============================================================
    var dailyData = [];
    var monthlyData = {};
    var alertsData = [];

    function parseCSV(text) {
      var lines = text.trim().split('\n');
      var headers = lines[0].split(',');
      var rows = [];
      for (var i = 1; i < lines.length; i++) {
        var values = lines[i].split(',');
        var row = {};
        for (var j = 0; j < headers.length; j++) {
          row[headers[j].trim()] = values[j] ? values[j].trim() : '';
        }
        rows.push(row);
      }
      return rows;
    }

    function loadAllData() {
      Promise.all([
        fetch('daily_mtd.csv').then(r => r.text()),
        fetch('monthly_trend.csv').then(r => r.text()),
        fetch('alerts.csv').then(r => r.text())
      ]).then(function(results) {
        // Parse daily data
        var dailyRows = parseCSV(results[0]);
        dailyData = dailyRows.map(function(r) {
          return {
            day: r.day,
            count: parseInt(r.count) || 0,
            isWeekend: r.isWeekend === 'true'
          };
        });

        // Parse monthly data - pivot into nested object
        var monthlyRows = parseCSV(results[1]);
        monthlyData = {};
        monthlyRows.forEach(function(r) {
          var vendor = r.vendor;
          if (!monthlyData[vendor]) monthlyData[vendor] = [];
          monthlyData[vendor].push({
            month: r.month,
            count: parseInt(r.count) || 0
          });
        });

        // Parse alerts data - filter for below 25% OR above 125%
        var alertRows = parseCSV(results[2]);
        alertsData = alertRows.map(function(r) {
          return {
            vendor: r.vendor,
            priorCount: parseInt(r.priorCount) || 0,
            currentCount: parseInt(r.currentCount) || 0,
            pct: parseFloat(r.pct) || 0
          };
        }).filter(function(r) {
          return r.priorCount >= 10 && (r.pct < 25 || r.pct > 125);
        });

        // Update KPIs
        updateKPIs();
        
        // Populate vendor dropdown
        populateVendorDropdown();

        // Render everything
        renderDailyChart();
        renderMonthlyChart('All Vendors');
        renderAlerts();
      }).catch(function(err) {
        console.error('Error loading CSV files:', err);
        alert('Error loading data files. Make sure daily_mtd.csv, monthly_trend.csv, and alerts.csv are in the same folder.');
      });
    }

    function updateKPIs() {
      // Yesterday (last day in daily data)
      if (dailyData.length > 0) {
        var yesterday = dailyData[dailyData.length - 1];
        document.getElementById('kpi-yesterday').textContent = yesterday.count.toLocaleString();
        document.querySelector('.kpi-card:first-child .kpi-sub').textContent = yesterday.day;
        
        // Update subtitle with data date
        document.querySelector('.subtitle').textContent = 'Invoice volume monitoring • Data through ' + yesterday.day;
      }

      // MTD
      var mtdTotal = dailyData.reduce(function(s, d) { return s + d.count; }, 0);
      document.getElementById('kpi-mtd').textContent = mtdTotal.toLocaleString();
      document.querySelector('.kpi-card:nth-child(2) .kpi-sub').textContent = dailyData.length + ' days';

      // YTD (sum of All Vendors monthly)
      var ytdTotal = 0;
      if (monthlyData['All Vendors']) {
        ytdTotal = monthlyData['All Vendors'].reduce(function(s, d) { return s + d.count; }, 0);
      }
      document.getElementById('kpi-ytd').textContent = ytdTotal.toLocaleString();

      // Alerts count
      document.getElementById('kpi-alerts').textContent = alertsData.length;
      document.querySelector('.tab[data-tab="alerts"]').textContent = 'Alerts (' + alertsData.length + ')';
      document.getElementById('alerts-count-label').textContent = alertsData.length + ' vendors flagged';
    }

    function populateVendorDropdown() {
      var select = document.getElementById('vendor-select');
      select.innerHTML = '';
      
      // Sort vendors, but keep "All Vendors" first
      var vendors = Object.keys(monthlyData).sort(function(a, b) {
        if (a === 'All Vendors') return -1;
        if (b === 'All Vendors') return 1;
        return a.localeCompare(b);
      });

      vendors.forEach(function(vendor) {
        var opt = document.createElement('option');
        opt.value = vendor;
        opt.textContent = vendor;
        select.appendChild(opt);
      });
    }

    // ============================================================
    // TAB SWITCHING
    // ============================================================
    document.querySelectorAll('.tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
      });
    });

    // ============================================================
    // DAILY BAR CHART
    // ============================================================
    function renderDailyChart() {
      var container = document.getElementById('daily-chart');
      var width = container.clientWidth || 900;
      var height = 320;
      var padding = { top: 20, right: 30, bottom: 50, left: 50 };
      var chartWidth = width - padding.left - padding.right;
      var chartHeight = height - padding.top - padding.bottom;

      var maxCount = Math.max.apply(null, dailyData.map(function(d) { return d.count; })) || 1;
      maxCount = Math.ceil(maxCount / 100) * 100 + 50;
      var barWidth = Math.floor(chartWidth / dailyData.length) - 6;
      var dailyAvg = Math.round(dailyData.reduce(function(s, d) { return s + d.count; }, 0) / dailyData.length);

      var svg = '<svg width="' + width + '" height="' + height + '">';
      
      // Grid lines and Y axis labels
      for (var i = 0; i <= 4; i++) {
        var y = padding.top + (chartHeight / 4) * i;
        var val = Math.round(maxCount - (maxCount / 4) * i);
        svg += '<line x1="' + padding.left + '" y1="' + y + '" x2="' + (width - padding.right) + '" y2="' + y + '" stroke="#3d4f63" stroke-dasharray="3,3"/>';
        svg += '<text x="' + (padding.left - 10) + '" y="' + (y + 4) + '" fill="#64748b" font-size="11" text-anchor="end">' + val + '</text>';
      }

      // Bars
      dailyData.forEach(function(d, idx) {
        var x = padding.left + idx * (chartWidth / dailyData.length) + 3;
        var barHeight = (d.count / maxCount) * chartHeight;
        var yPos = padding.top + chartHeight - barHeight;
        var opacity = d.isWeekend ? 0.4 : 1;
        svg += '<rect x="' + x + '" y="' + yPos + '" width="' + barWidth + '" height="' + barHeight + '" fill="#4A9B52" opacity="' + opacity + '" rx="3"/>';
        svg += '<text x="' + (x + barWidth / 2) + '" y="' + (height - 15) + '" fill="#64748b" font-size="10" text-anchor="middle">' + d.day + '</text>';
      });

      // Average line
      var avgY = padding.top + chartHeight - (dailyAvg / maxCount) * chartHeight;
      svg += '<line x1="' + padding.left + '" y1="' + avgY + '" x2="' + (width - padding.right) + '" y2="' + avgY + '" stroke="#f59e0b" stroke-width="2" stroke-dasharray="6,4"/>';

      svg += '</svg>';
      container.innerHTML = svg;
    }

    // ============================================================
    // MONTHLY LINE CHART
    // ============================================================
    function renderMonthlyChart(vendor) {
      var data = monthlyData[vendor] || [];
      var container = document.getElementById('monthly-chart');
      var width = container.clientWidth || 900;
      var height = 320;
      var padding = { top: 20, right: 30, bottom: 50, left: 60 };
      var chartWidth = width - padding.left - padding.right;
      var chartHeight = height - padding.top - padding.bottom;

      if (!data.length) {
        container.innerHTML = '<div style="text-align:center;padding:80px;color:#64748b;">No data</div>';
        return;
      }

      var maxCount = Math.max.apply(null, data.map(function(d) { return d.count; })) || 1;
      maxCount = Math.ceil(maxCount / 1000) * 1000 + 500;
      var ytd = data.reduce(function(s, d) { return s + d.count; }, 0);
      var avg = Math.round(ytd / data.length);
      var peak = data.reduce(function(m, d) { return d.count > m.count ? d : m; });

      document.getElementById('stat-ytd').textContent = ytd.toLocaleString();
      document.getElementById('stat-monthly-avg').textContent = avg.toLocaleString();
      document.getElementById('stat-peak-month').textContent = peak.month;
      document.getElementById('stat-peak-vol').textContent = peak.count.toLocaleString();

      var svg = '<svg width="' + width + '" height="' + height + '">';
      
      // Grid
      for (var i = 0; i <= 4; i++) {
        var y = padding.top + (chartHeight / 4) * i;
        var val = maxCount - (maxCount / 4) * i;
        var label = val >= 1000 ? (val / 1000).toFixed(0) + 'k' : Math.round(val);
        svg += '<line x1="' + padding.left + '" y1="' + y + '" x2="' + (width - padding.right) + '" y2="' + y + '" stroke="#3d4f63" stroke-dasharray="3,3"/>';
        svg += '<text x="' + (padding.left - 10) + '" y="' + (y + 4) + '" fill="#64748b" font-size="11" text-anchor="end">' + label + '</text>';
      }

      // Line path
      var path = '';
      var points = [];
      data.forEach(function(d, idx) {
        var x = padding.left + (idx / (data.length - 1 || 1)) * chartWidth;
        var yPos = padding.top + chartHeight - (d.count / maxCount) * chartHeight;
        points.push({ x: x, y: yPos, month: d.month, count: d.count });
        path += (idx === 0 ? 'M' : 'L') + x + ',' + yPos;
      });
      svg += '<path d="' + path + '" fill="none" stroke="#4A9B52" stroke-width="2.5"/>';

      // Dots and labels
      points.forEach(function(p) {
        svg += '<circle cx="' + p.x + '" cy="' + p.y + '" r="5" fill="#4A9B52"/>';
        svg += '<circle cx="' + p.x + '" cy="' + p.y + '" r="3" fill="#2a3a4d"/>';
        svg += '<text x="' + p.x + '" y="' + (height - 15) + '" fill="#64748b" font-size="11" text-anchor="middle">' + p.month + '</text>';
      });

      svg += '</svg>';
      container.innerHTML = svg;
    }

    // ============================================================
    // ALERTS TABLE
    // ============================================================
    function renderAlerts() {
      var tbody = document.getElementById('alerts-table');
      var html = '';
      alertsData.forEach(function(r) {
        var isSpike = r.pct > 100;
        var change = isSpike ? (r.pct - 100).toFixed(0) : (100 - r.pct).toFixed(0);
        var badgeClass = isSpike ? 'badge spike' : 'badge';
        var arrow = isSpike ? '↑' : '↓';
        var label = isSpike ? 'spike' : 'drop';
        html += '<tr>';
        html += '<td>' + r.vendor + '</td>';
        html += '<td class="right muted">' + r.priorCount + '</td>';
        html += '<td class="right ' + (isSpike ? 'green' : 'red') + '">' + r.currentCount + '</td>';
        html += '<td class="right ' + (isSpike ? 'green' : 'red') + '">' + r.pct.toFixed(1) + '%</td>';
        html += '<td class="right"><span class="' + badgeClass + '">' + arrow + ' ' + change + '% ' + label + '</span></td>';
        html += '</tr>';
      });
      tbody.innerHTML = html;
    }

    // ============================================================
    // VENDOR SELECT
    // ============================================================
    document.getElementById('vendor-select').addEventListener('change', function() {
      renderMonthlyChart(this.value);
    });

    // ============================================================
    // INIT
    // ============================================================
    loadAllData();

    window.addEventListener('resize', function() {
      renderDailyChart();
      renderMonthlyChart(document.getElementById('vendor-select').value);
    });
  </script>
</body>
</html>
